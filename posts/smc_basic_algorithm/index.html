<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Introduction # Sequential Monte Carlo (SMC) can be used to take samples from posterior distributions, as an alternative to popular methods such as Markov Chain Monte Carlo (MCMC) like Metropolis-Hastings, Gibbs Sampling or more state-of-the-art Hamiltonian Monte Carlo (HMC) and No-U-Turn Sampler (NUTS).
Instead of creating a single Markov Chain, SMC works by keeping track of a large population of samples, which, in a similar spirit to Genetic Algorithms can be &ldquo;selected&rdquo; and &ldquo;mutated&rdquo; to evolve a better &ldquo;fit&rdquo; to the posterior distribution."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="A simple Sequential Monte Carlo algorithm for posterior approximation"><meta property="og:description" content="Introduction # Sequential Monte Carlo (SMC) can be used to take samples from posterior distributions, as an alternative to popular methods such as Markov Chain Monte Carlo (MCMC) like Metropolis-Hastings, Gibbs Sampling or more state-of-the-art Hamiltonian Monte Carlo (HMC) and No-U-Turn Sampler (NUTS).
Instead of creating a single Markov Chain, SMC works by keeping track of a large population of samples, which, in a similar spirit to Genetic Algorithms can be &ldquo;selected&rdquo; and &ldquo;mutated&rdquo; to evolve a better &ldquo;fit&rdquo; to the posterior distribution."><meta property="og:type" content="article"><meta property="og:url" content="https://ricardov94.github.io/posts/smc_basic_algorithm/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-06T00:00:00+00:00"><meta property="article:modified_time" content="2021-08-06T00:00:00+00:00"><title>A simple Sequential Monte Carlo algorithm for posterior approximation | As long as everything adds up to one</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.336536302c9333426b2435f844b8628561bae88f21fec7883f90118e27d33980.css integrity="sha256-M2U2MCyTM0JrJDX4RLhihWG66I8h/seIP5ARjifTOYA=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.6248f0d4778be3a7f06cb3a79412a91077b31b0fd8bc3ea06e6436002692323d.js integrity="sha256-Ykjw1HeL46fwbLOnlBKpEHezGw/YvD6gbmQ2ACaSMj0=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/><span>As long as everything adds up to one</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-d0a97e81e6c04bf86dad2e667144930c class=toggle>
<label for=section-d0a97e81e6c04bf86dad2e667144930c class="flex justify-between"><a role=button>Gsoc 2021</a></label><ul><li><a href=https://ricardov94.github.io/topics/gsoc-2021/proposal/>Proposal</a></li><li><a href=https://ricardov94.github.io/topics/gsoc-2021/completed_work/>Completed Work</a></li></ul></li></ul><ul><li><a href=/posts/>Blog</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>A simple Sequential Monte Carlo algorithm for posterior approximation</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#toy-2d-gaussian-example>Toy 2D Gaussian example</a></li></ul></li><li><a href=#a-particle-is-born>A particle is born</a></li><li><a href=#picking-favorites>Picking favorites</a></li><li><a href=#introducing-variation>Introducing variation</a><ul><li><a href=#blind-evolution>Blind evolution</a></li><li><a href=#intelligent-design>Intelligent design</a></li></ul></li><li><a href=#summary>Summary</a></li><li><a href=#what-about-the-prior>What about the prior?</a></li></ul></nav><script>code_show=!0;function code_toggle(){code_show=!code_show,show=code_show?"block":"none",code_blocks=document.querySelectorAll(":not(.never-hide) > .highlight");for(let e of code_blocks)e.style.display=show}code_toggle()</script><a class=book-btn href=javascript:code_toggle()>Toggle Code</a></aside></header><article class=markdown><h1><a href=/posts/smc_basic_algorithm/>A simple Sequential Monte Carlo algorithm for posterior approximation</a></h1><h5>August 6, 2021</h5><div><a href=/categories/probability/>probability</a></div><div><a href=/tags/algorithm/>algorithm</a>,
<a href=/tags/smc/>SMC</a></div><h2 id=introduction>Introduction
<a class=anchor href=#introduction>#</a></h2><p>Sequential Monte Carlo (SMC) can be used to take samples from posterior distributions, as an alternative to popular methods such as Markov Chain Monte Carlo (MCMC) like Metropolis-Hastings, Gibbs Sampling or more state-of-the-art Hamiltonian Monte Carlo (HMC) and No-U-Turn Sampler (NUTS).</p><p>Instead of creating a single Markov Chain, SMC works by keeping track of a large population of samples, which, in a similar spirit to <a href=https://en.wikipedia.org/wiki/Genetic_algorithm>Genetic Algorithms</a> can be &ldquo;selected&rdquo; and &ldquo;mutated&rdquo; to evolve a better &ldquo;fit&rdquo; to the posterior distribution.</p><p>Experience suggests SMC is particularly well fit to the following settings:</p><ol><li>Multi-modal posterior distributions</li><li>Online inference when data accumulates over time</li><li>Approximate Bayesian Inference when the likelihood function cannot be easily written down</li></ol><p>In this article I introduce the basic components that make up a simple SMC algorithm. In future articles, I present more complex variations that build up towards the specific algorithm that is employed in the <a href=https://docs.pymc.io/>PyMC3</a> library.</p><h3 id=toy-2d-gaussian-example>Toy 2D Gaussian example
<a class=anchor href=#toy-2d-gaussian-example>#</a></h3><p>As with MCMC, SMC approximates the posterior distribution via careful weighted sampling. However, while MCMC approximates a distribution through a single random walk that unrolls over time, SMC does this in a parallel manner. At each step, it keeps track of a series of samples (also known as particles) that approximate the distribution as a whole.</p><p>This picture tries to illustrate this distinction for a simple 2D Gaussian posterior that will be used throughout this article:</p><br><link rel=stylesheet href=/katex/katex.min.css><script defer src=/katex/katex.min.js></script>
<script defer src=/katex/auto-render.min.js onload=renderMathInElement(document.body)></script><span>
\(\)</span><p>\[
\text{pdf}(x, y) = \text{exp}(-\begin{bmatrix}x\\ y\end{bmatrix}^T \begin{bmatrix}1&amp;0.5\\ 0.5&amp;1\end{bmatrix}^{-1} \begin{bmatrix}x\\ y\end{bmatrix})
\]</p><br><p><img src=MCMC_vs_SMC.png alt="MCMC vs SMC approximation to the posterior"></p><p><em>Approximation to the 2D Gaussian posterior shown on the left plot. The middle plot shows the approximation from a single MCMC chain, with the samples connected sequentially, emphasizing the autocorrelated random walk behavior. The right plot shows the approximation from the SMC algorithm, where each sample is independent from the rest.</em></p><blockquote class="book-hint info"><p><strong>Why are we even doing this?</strong></p><p>The example above with a 2D Gaussian is deceptively simple and there is no reason why we would need to use Monte Carlo approximations (be it MCMC or SMC) to understand it. Usually in the context of Bayesian data analysis we are working with a model that describes a complicated and highly dimensional posterior distribution that cannot be written down mathematically (or as mathematicians prefer, analytically).</p><p>In addition, even if the posterior distribution could be described mathematically, it is often very difficult to work with. We are usually interested in chopping the posterior distribution into a smaller number of components that we care about (marginalization) or summarizing it into metrics that are understandable such as correlations, averages and standard deviations (expectations). Surprisingly, these sort of operations are trivial if we can get a hold of a representative set of samples from the distribution in question. All we need is to do some smart indexing and call functions such as <code>numpy.mean()</code> and <code>numpy.std()</code>!</p></blockquote><p>The core of the SMC algorithm is very simple:</p><ol><li>We start by creating a large population of particles, usually by sampling from the prior distribution.</li><li>We then compute a weight for each particle, which is proportional to the posterior probability at that &ldquo;point&rdquo;.</li><li>These weights are used to sample, with replacement, a new population of particles. This will lead to a population that is more representative of the posterior distribution. On average, a particle that is 3x more probable than another will be resampled 3x as often.</li><li>Finally, we introduce some &ldquo;mutations&rdquo; in the population. This could be as simple as adding a random uniform jittering to each particle dimension, but, we can also try to &ldquo;guide&rdquo; the particles in a more clever way towards areas of larger posterior mass.</li></ol><p>The pseudocode for the SMC algorithm is given below:</p><div class=never-hide><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># hyperparameters</span>
</span></span><span style=display:flex><span><span style=color:#111>n_particles</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2000</span>
</span></span><span style=display:flex><span><span style=color:#111>n_steps</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># initialize population of particles from prior</span>
</span></span><span style=display:flex><span><span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>sample_prior</span><span style=color:#111>(</span><span style=color:#111>n_particles</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># main loop</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span> <span style=color:#111>step</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#111>n_steps</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># compute particle weights in proportion</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># to the posterior distribution probability</span>
</span></span><span style=display:flex><span>    <span style=color:#111>weights</span> <span style=color:#f92672>=</span> <span style=color:#111>compute_weights</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>posterior</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># resample particles (with replacement)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># based on their weights</span>
</span></span><span style=display:flex><span>    <span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>resample</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>weights</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># mutate particles to reintroduce variation</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># and better explore the posterior distribution</span>
</span></span><span style=display:flex><span>    <span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>mutate</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># final approximation is given by the final particles</span>
</span></span><span style=display:flex><span><span style=color:#111>posterior</span> <span style=color:#f92672>=</span> <span style=color:#111>particles</span>
</span></span></code></pre></div></div><p>Let&rsquo;s flesh out these steps in detail.</p><h2 id=a-particle-is-born>A particle is born
<a class=anchor href=#a-particle-is-born>#</a></h2><blockquote class="book-hint info"><p><strong>What is a particle?</strong></p><p>A particle (or a sample in conventional MCMC) is a numerical vector with one entry for each parameter in the posterior function that we are interested in. In the 2D Gaussian example above it was a 2D-vector with <code>{x, y}</code> coordinates.</p><pre><code>particle = {&quot;x&quot;: -0.5, &quot;y&quot;: 0.2}
</code></pre><p>In a simple linear regression model it might be an \(N^D\)-vector containing a value for the <code>intercept</code>, a <code>coefficient</code> for each predictor in our dataset and a <code>noise</code> term for the observations.</p><pre><code>particle = {&quot;intercept&quot;: 1.0, &quot;coef_1&quot;: 0.5, &quot;coef_2&quot;: 0.2, &quot;noise&quot;: 3.0}
</code></pre></blockquote><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>numpy</span> <span style=color:#00a8c8>as</span> <span style=color:#111>np</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>scipy.stats</span> <span style=color:#00a8c8>as</span> <span style=color:#111>st</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>matplotlib.pyplot</span> <span style=color:#00a8c8>as</span> <span style=color:#111>plt</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>seaborn</span> <span style=color:#00a8c8>as</span> <span style=color:#111>sns</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>sns</span><span style=color:#f92672>.</span><span style=color:#111>set_style</span><span style=color:#111>(</span><span style=color:#d88200>&#34;dark&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>sns</span><span style=color:#f92672>.</span><span style=color:#111>set</span><span style=color:#111>(</span><span style=color:#111>font_scale</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1.4</span><span style=color:#111>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>create_plot</span><span style=color:#111>(</span><span style=color:#111>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>cols</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>fig</span><span style=color:#111>,</span> <span style=color:#111>ax</span> <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>subplots</span><span style=color:#111>(</span><span style=color:#111>rows</span><span style=color:#111>,</span> <span style=color:#111>cols</span><span style=color:#111>,</span> <span style=color:#111>figsize</span><span style=color:#f92672>=</span><span style=color:#111>(</span><span style=color:#ae81ff>6</span><span style=color:#f92672>*</span><span style=color:#111>cols</span><span style=color:#111>,</span> <span style=color:#ae81ff>6</span><span style=color:#f92672>*</span><span style=color:#111>rows</span><span style=color:#111>),</span> <span style=color:#111>sharex</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>,</span> <span style=color:#111>sharey</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># single plot</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>rows</span> <span style=color:#f92672>+</span> <span style=color:#111>cols</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>set_aspect</span><span style=color:#111>(</span><span style=color:#d88200>&#39;equal&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;box&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>set_xticks</span><span style=color:#111>([])</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>set_yticks</span><span style=color:#111>([])</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#75715e># multiple plot</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#111>axi</span> <span style=color:#f92672>in</span> <span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>ravel</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>            <span style=color:#111>axi</span><span style=color:#f92672>.</span><span style=color:#111>set_aspect</span><span style=color:#111>(</span><span style=color:#d88200>&#39;equal&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;box&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>axi</span><span style=color:#f92672>.</span><span style=color:#111>set_xticks</span><span style=color:#111>([])</span>
</span></span><span style=display:flex><span>            <span style=color:#111>axi</span><span style=color:#f92672>.</span><span style=color:#111>set_yticks</span><span style=color:#111>([])</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>fig</span><span style=color:#111>,</span> <span style=color:#111>ax</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>make_arrow</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>,</span> <span style=color:#111>b</span><span style=color:#111>,</span> <span style=color:#111>axA</span><span style=color:#111>,</span> <span style=color:#111>axB</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> <span style=color:#111>matplotlib.patches</span> <span style=color:#f92672>import</span> <span style=color:#111>ConnectionPatch</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>ConnectionPatch</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>        <span style=color:#111>a</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>b</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>coordsA</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;axes fraction&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>coordsB</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;axes fraction&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>axesA</span><span style=color:#f92672>=</span><span style=color:#111>axA</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>axesB</span><span style=color:#f92672>=</span><span style=color:#111>axB</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>color</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;k&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>fc</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;k&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>arrowstyle</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;-|&gt;&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mutation_scale</span><span style=color:#f92672>=</span><span style=color:#ae81ff>30</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>lw</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>zorder</span><span style=color:#f92672>=</span><span style=color:#ae81ff>10</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>)</span>
</span></span></code></pre></div><p>Let&rsquo;s create our very first particles:</p><div class=never-hide><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>Particle</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>y</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>x</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#f92672>=</span> <span style=color:#111>y</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>adam</span><span style=color:#111>,</span> <span style=color:#111>eve</span> <span style=color:#f92672>=</span> <span style=color:#111>Particle</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>y</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>),</span> <span style=color:#111>Particle</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#111>y</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span></code></pre></div></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>_</span><span style=color:#111>,</span> <span style=color:#111>ax</span> <span style=color:#f92672>=</span> <span style=color:#111>create_plot</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>adam</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>adam</span><span style=color:#f92672>.</span><span style=color:#111>y</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>annotate</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Adam&#34;</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#111>adam</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>adam</span><span style=color:#f92672>.</span><span style=color:#111>y</span><span style=color:#f92672>+</span><span style=color:#ae81ff>.1</span><span style=color:#111>),</span> <span style=color:#111>ha</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;center&#34;</span><span style=color:#111>,</span> <span style=color:#111>fontsize</span><span style=color:#f92672>=</span><span style=color:#ae81ff>16</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>eve</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>eve</span><span style=color:#f92672>.</span><span style=color:#111>y</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>annotate</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Eve&#34;</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#111>eve</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>eve</span><span style=color:#f92672>.</span><span style=color:#111>y</span><span style=color:#f92672>+</span><span style=color:#ae81ff>.1</span><span style=color:#111>),</span> <span style=color:#111>ha</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;center&#34;</span><span style=color:#111>,</span> <span style=color:#111>fontsize</span><span style=color:#f92672>=</span><span style=color:#ae81ff>16</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>set_xlim</span><span style=color:#111>([</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0.5</span><span style=color:#111>,</span> <span style=color:#ae81ff>1.5</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>set_ylim</span><span style=color:#111>([</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0.5</span><span style=color:#111>,</span> <span style=color:#ae81ff>1.5</span><span style=color:#111>]);</span>
</span></span></code></pre></div><p><img src=output_15_0.png alt=png></p><p>Kidding aside, we need to get a whole population of particles. How should we choose?</p><p>Making the effort to pick a good initial population can be very useful. Remember that the goal is to obtain a representative sample from the posterior distribution, and so the closer our initial population is to the posterior, the closer we are to being done.</p><p>Regardless, and to keep things simple with our toy example, we will just take a random sample from the uniform grid:</p><div class=never-hide><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>sample_uniform_grid</span><span style=color:#111>(</span><span style=color:#111>min_x</span><span style=color:#111>,</span> <span style=color:#111>max_x</span><span style=color:#111>,</span> <span style=color:#111>min_y</span><span style=color:#111>,</span> <span style=color:#111>max_y</span><span style=color:#111>,</span> <span style=color:#111>n</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>[]</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>i</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>random</span><span style=color:#f92672>.</span><span style=color:#111>uniform</span><span style=color:#111>(</span><span style=color:#111>min_x</span><span style=color:#111>,</span> <span style=color:#111>max_x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>y</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>random</span><span style=color:#f92672>.</span><span style=color:#111>uniform</span><span style=color:#111>(</span><span style=color:#111>min_y</span><span style=color:#111>,</span> <span style=color:#111>max_y</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>particle</span> <span style=color:#f92672>=</span> <span style=color:#111>Particle</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#f92672>=</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>y</span><span style=color:#f92672>=</span><span style=color:#111>y</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>particles</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>particle</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>particles</span>
</span></span></code></pre></div></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>sample_uniform_grid</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#111>n</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>_</span><span style=color:#111>,</span> <span style=color:#111>ax</span> <span style=color:#f92672>=</span> <span style=color:#111>create_plot</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>xs</span><span style=color:#111>,</span> <span style=color:#111>ys</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;The prior population&#34;</span><span style=color:#111>);</span>
</span></span></code></pre></div><p><img src=output_20_0.png alt=png></p><h2 id=picking-favorites>Picking favorites
<a class=anchor href=#picking-favorites>#</a></h2><p>Now that we have a population of particles, it&rsquo;s time to evolve it into a proper approximation of the posterior distribution! To do this, we weight each particle by its posterior probability, normalize all the population weights so that they add up to <code>1.0</code> and use them to resample with replacement.</p><div class=never-hide><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>posterior</span><span style=color:#111>(</span><span style=color:#111>particle</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;&#34;&#34; 
</span></span></span><span style=display:flex><span><span style=color:#d88200>    Unnormalized 2D Gaussian with [0, 0] mean 
</span></span></span><span style=display:flex><span><span style=color:#d88200>    and [[0.5, 1.0], [1.0, 0.5]] covariance matrix 
</span></span></span><span style=display:flex><span><span style=color:#d88200>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>xy</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>([</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>    <span style=color:#111>cov</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>([[</span><span style=color:#ae81ff>1.0</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>],</span> <span style=color:#111>[</span><span style=color:#ae81ff>0.5</span><span style=color:#111>,</span> <span style=color:#ae81ff>1.0</span><span style=color:#111>]])</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>exp</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#111>(</span><span style=color:#111>xy</span><span style=color:#111>)</span> <span style=color:#f92672>@</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>linalg</span><span style=color:#f92672>.</span><span style=color:#111>inv</span><span style=color:#111>(</span><span style=color:#111>cov</span><span style=color:#111>)</span> <span style=color:#f92672>@</span> <span style=color:#111>(</span><span style=color:#111>xy</span><span style=color:#111>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>compute_weights</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>posterior</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>weights</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>([</span><span style=color:#111>posterior</span><span style=color:#111>(</span><span style=color:#111>particle</span><span style=color:#111>)</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>    <span style=color:#111>weights</span> <span style=color:#f92672>/=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>sum</span><span style=color:#111>(</span><span style=color:#111>weights</span><span style=color:#111>)</span>  <span style=color:#75715e># normalize weights</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>weights</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>resample</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>weights</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>idxs</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>arange</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>sampled_idxs</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>random</span><span style=color:#f92672>.</span><span style=color:#111>choice</span><span style=color:#111>(</span><span style=color:#111>idxs</span><span style=color:#111>,</span> <span style=color:#111>p</span><span style=color:#f92672>=</span><span style=color:#111>weights</span><span style=color:#111>,</span> <span style=color:#111>replace</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>,</span> <span style=color:#111>size</span><span style=color:#f92672>=</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>resampled_particles</span> <span style=color:#f92672>=</span> <span style=color:#111>[]</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>idx</span> <span style=color:#f92672>in</span> <span style=color:#111>sampled_idxs</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>resampled_particles</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>[</span><span style=color:#111>idx</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>resampled_particles</span>
</span></span></code></pre></div></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>_</span><span style=color:#111>,</span> <span style=color:#111>ax</span> <span style=color:#f92672>=</span> <span style=color:#111>create_plot</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>xs</span><span style=color:#111>,</span> <span style=color:#111>ys</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Initial particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>weights</span> <span style=color:#f92672>=</span> <span style=color:#111>compute_weights</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>posterior</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>rescaled_weights</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.95</span> <span style=color:#f92672>*</span> <span style=color:#111>(</span><span style=color:#111>weights</span> <span style=color:#f92672>-</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#111>weights</span><span style=color:#111>))</span> <span style=color:#f92672>/</span> <span style=color:#111>(</span><span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>max</span><span style=color:#111>(</span><span style=color:#111>weights</span><span style=color:#111>)</span> <span style=color:#f92672>-</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#111>weights</span><span style=color:#111>))</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.05</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>xs</span><span style=color:#111>,</span> <span style=color:#111>ys</span><span style=color:#111>,</span> <span style=color:#111>s</span><span style=color:#f92672>=</span><span style=color:#ae81ff>150</span> <span style=color:#f92672>*</span> <span style=color:#111>rescaled_weights</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>,</span> <span style=color:#111>color</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;C3&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Particle weights&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>resampled_particles</span> <span style=color:#f92672>=</span> <span style=color:#111>resample</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>weights</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>resampled_particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>resampled_particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>xs</span><span style=color:#111>,</span> <span style=color:#111>ys</span><span style=color:#111>,</span> <span style=color:#111>s</span><span style=color:#f92672>=</span><span style=color:#ae81ff>50</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Resampled particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>add_artist</span><span style=color:#111>(</span><span style=color:#111>make_arrow</span><span style=color:#111>((</span><span style=color:#ae81ff>0.85</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#ae81ff>0.15</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>],</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]));</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>add_artist</span><span style=color:#111>(</span><span style=color:#111>make_arrow</span><span style=color:#111>((</span><span style=color:#ae81ff>0.85</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#ae81ff>0.15</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>],</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]));</span>
</span></span></code></pre></div><p><img src=output_28_0.png alt=png></p><p><em>The initial population of particles is shown on the left plot. In the middle plot each particle is given a weight proportional to its posterior probability. The weights are illustrated by the particle size. In the right plot, the particles were resampled with replacement based on their weights. Each particle is plotted with the same transparency, and those resampled multiple times appear to be darker.</em></p><h2 id=introducing-variation>Introducing variation
<a class=anchor href=#introducing-variation>#</a></h2><p>The example above was a favorable one, where the initial population of particles happened to cover the bulk of the posterior distribution. We may not always be this lucky, for instance when working with very complex distributions or when our choice for initial population of particles is not great, as in the exaggerated example below:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>_</span><span style=color:#111>,</span> <span style=color:#111>ax</span> <span style=color:#f92672>=</span> <span style=color:#111>create_plot</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_xlim</span><span style=color:#111>([</span><span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_ylim</span><span style=color:#111>([</span><span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>bad_particles</span> <span style=color:#f92672>=</span> <span style=color:#111>sample_uniform_grid</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>500</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>bad_particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>bad_particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>xs</span><span style=color:#111>,</span> <span style=color:#111>ys</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Initial particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>weights</span> <span style=color:#f92672>=</span> <span style=color:#111>compute_weights</span><span style=color:#111>(</span><span style=color:#111>bad_particles</span><span style=color:#111>,</span> <span style=color:#111>posterior</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>rescaled_weights</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.95</span> <span style=color:#f92672>*</span> <span style=color:#111>(</span><span style=color:#111>weights</span> <span style=color:#f92672>-</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#111>weights</span><span style=color:#111>))</span> <span style=color:#f92672>/</span> <span style=color:#111>(</span><span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>max</span><span style=color:#111>(</span><span style=color:#111>weights</span><span style=color:#111>)</span> <span style=color:#f92672>-</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#111>weights</span><span style=color:#111>))</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.05</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>xs</span><span style=color:#111>,</span> <span style=color:#111>ys</span><span style=color:#111>,</span> <span style=color:#111>s</span><span style=color:#f92672>=</span><span style=color:#ae81ff>150</span> <span style=color:#f92672>*</span> <span style=color:#111>rescaled_weights</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>,</span> <span style=color:#111>color</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;C3&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Particle weights&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>bad_resampled_particles</span> <span style=color:#f92672>=</span> <span style=color:#111>resample</span><span style=color:#111>(</span><span style=color:#111>bad_particles</span><span style=color:#111>,</span> <span style=color:#111>weights</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>bad_resampled_particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>bad_resampled_particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>xs</span><span style=color:#111>,</span> <span style=color:#111>ys</span><span style=color:#111>,</span> <span style=color:#111>s</span><span style=color:#f92672>=</span><span style=color:#ae81ff>50</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Resampled particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>add_artist</span><span style=color:#111>(</span><span style=color:#111>make_arrow</span><span style=color:#111>((</span><span style=color:#ae81ff>0.85</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#ae81ff>0.15</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>],</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]));</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>add_artist</span><span style=color:#111>(</span><span style=color:#111>make_arrow</span><span style=color:#111>((</span><span style=color:#ae81ff>0.85</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#ae81ff>0.15</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>],</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]));</span>
</span></span></code></pre></div><p><img src=output_31_0.png alt=png></p><p>To obtain a robust algorithm we need some way for the population to &ldquo;evolve&rdquo; towards the target distribution. This is achieved by mutating the particles.</p><p>The mutation step is also important for reintroducing variability after the resampling step. Because resampled particles are exact copies of each other, if we were to rerun the weighting and resampling steps several times, the population would quickly converge to a singular particle.</p><h3 id=blind-evolution>Blind evolution
<a class=anchor href=#blind-evolution>#</a></h3><p>The simplest mutation strategy is to add a random offset to each particle parameter:</p><div class=never-hide><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>random_mutation</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>):</span>   
</span></span><span style=display:flex><span>    <span style=color:#111>new_particles</span> <span style=color:#f92672>=</span> <span style=color:#111>[]</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Add Gaussian noise around each particle dimension</span>
</span></span><span style=display:flex><span>        <span style=color:#111>new_x</span> <span style=color:#f92672>=</span> <span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#f92672>+</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>random</span><span style=color:#f92672>.</span><span style=color:#111>normal</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>new_y</span> <span style=color:#f92672>=</span> <span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#f92672>+</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>random</span><span style=color:#f92672>.</span><span style=color:#111>normal</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>new_particle</span> <span style=color:#f92672>=</span> <span style=color:#111>Particle</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#f92672>=</span><span style=color:#111>new_x</span><span style=color:#111>,</span> <span style=color:#111>y</span><span style=color:#f92672>=</span><span style=color:#111>new_y</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>new_particles</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>new_particle</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>new_particles</span>
</span></span></code></pre></div></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>_</span><span style=color:#111>,</span> <span style=color:#111>ax</span> <span style=color:#f92672>=</span> <span style=color:#111>create_plot</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#ae81ff>4</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_xlim</span><span style=color:#111>([</span><span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_ylim</span><span style=color:#111>([</span><span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>bad_resampled_particles</span>
</span></span><span style=display:flex><span><span style=color:#111>xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>xs</span><span style=color:#111>,</span> <span style=color:#111>ys</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Resampled particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>random_mutation</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>new_xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>new_ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>new_xs</span><span style=color:#111>,</span> <span style=color:#111>new_ys</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Mutated particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>weights</span> <span style=color:#f92672>=</span> <span style=color:#111>compute_weights</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>posterior</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>resample</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>weights</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>xs</span><span style=color:#111>,</span> <span style=color:#111>ys</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Resampled particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>random_mutation</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>new_xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>new_ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>new_xs</span><span style=color:#111>,</span> <span style=color:#111>new_ys</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Mutated particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>add_artist</span><span style=color:#111>(</span><span style=color:#111>make_arrow</span><span style=color:#111>((</span><span style=color:#ae81ff>0.85</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#ae81ff>0.15</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>],</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]));</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>add_artist</span><span style=color:#111>(</span><span style=color:#111>make_arrow</span><span style=color:#111>((</span><span style=color:#ae81ff>0.85</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#ae81ff>0.15</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>],</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]));</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>add_artist</span><span style=color:#111>(</span><span style=color:#111>make_arrow</span><span style=color:#111>((</span><span style=color:#ae81ff>0.85</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#ae81ff>0.15</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>],</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>3</span><span style=color:#111>]));</span>
</span></span></code></pre></div><p><img src=output_36_0.png alt=png></p><h3 id=intelligent-design>Intelligent design
<a class=anchor href=#intelligent-design>#</a></h3><p>Creationists might have gotten it wrong when it comes to natural selection, but their premise makes a lot of sense: It would all have been much easier if someone had taken the driving seat. Fortunately that is something we can do in SMC, and in particular when it comes to how we mutate the population of particles.</p><p>Instead of using a blind form of &ldquo;mutation&rdquo; as above, we can intelligently drive the particles towards areas of high probability in the posterior distribution. One way of doing this is to run each particle through a traditional MCMC algorithm for a specific number of steps and take the final position as the new mutated particle.</p><div class=never-hide><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>metropolis_hastings_mutation</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>):</span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e># This should be parallelized</span>
</span></span><span style=display:flex><span>    <span style=color:#111>new_particles</span> <span style=color:#f92672>=</span> <span style=color:#111>[]</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>new_particle</span> <span style=color:#f92672>=</span> <span style=color:#111>single_particle_mh</span><span style=color:#111>(</span><span style=color:#111>particle</span><span style=color:#111>,</span> <span style=color:#111>steps</span><span style=color:#f92672>=</span><span style=color:#ae81ff>10</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>new_particles</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>new_particle</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>new_particles</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>single_particle_mh</span><span style=color:#111>(</span><span style=color:#111>particle</span><span style=color:#111>,</span> <span style=color:#111>steps</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#d88200>    Run a small Metropolis-Hastings MCMC chain around a single particle
</span></span></span><span style=display:flex><span><span style=color:#d88200>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># The proposal distribution should be tuned</span>
</span></span><span style=display:flex><span>    <span style=color:#111>proposal_distribution</span> <span style=color:#f92672>=</span> <span style=color:#111>st</span><span style=color:#f92672>.</span><span style=color:#111>norm</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>step</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#111>steps</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#111>x_offset</span><span style=color:#111>,</span> <span style=color:#111>y_offset</span> <span style=color:#f92672>=</span> <span style=color:#111>proposal_distribution</span><span style=color:#f92672>.</span><span style=color:#111>rvs</span><span style=color:#111>(</span><span style=color:#ae81ff>2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>new_particle</span> <span style=color:#f92672>=</span> <span style=color:#111>Particle</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>            <span style=color:#111>x</span><span style=color:#f92672>=</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#f92672>+</span> <span style=color:#111>x_offset</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>            <span style=color:#111>y</span><span style=color:#f92672>=</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#f92672>+</span> <span style=color:#111>y_offset</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Compute Metropolis-Hastings jump probability given the ratio</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># between current and proposed particle probability</span>
</span></span><span style=display:flex><span>        <span style=color:#111>current_probability</span> <span style=color:#f92672>=</span> <span style=color:#111>posterior</span><span style=color:#111>(</span><span style=color:#111>particle</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>proposed_probability</span> <span style=color:#f92672>=</span> <span style=color:#111>posterior</span><span style=color:#111>(</span><span style=color:#111>new_particle</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>jump_probability</span> <span style=color:#f92672>=</span> <span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>proposed_probability</span> <span style=color:#f92672>/</span> <span style=color:#111>current_probability</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>jump_probability</span> <span style=color:#f92672>&gt;=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>random</span><span style=color:#f92672>.</span><span style=color:#111>rand</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>            <span style=color:#111>particle</span> <span style=color:#f92672>=</span> <span style=color:#111>new_particle</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>particle</span> <span style=color:#f92672>=</span> <span style=color:#111>particle</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>particle</span>
</span></span></code></pre></div></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>_</span><span style=color:#111>,</span> <span style=color:#111>ax</span> <span style=color:#f92672>=</span> <span style=color:#111>create_plot</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#ae81ff>4</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_xlim</span><span style=color:#111>([</span><span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_ylim</span><span style=color:#111>([</span><span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>bad_resampled_particles</span>
</span></span><span style=display:flex><span><span style=color:#111>xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>xs</span><span style=color:#111>,</span> <span style=color:#111>ys</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Resampled particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>metropolis_hastings_mutation</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>new_xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>new_ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>new_xs</span><span style=color:#111>,</span> <span style=color:#111>new_ys</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Mutated particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>weights</span> <span style=color:#f92672>=</span> <span style=color:#111>compute_weights</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>posterior</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>resample</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>weights</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>xs</span><span style=color:#111>,</span> <span style=color:#111>ys</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Resampled particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>random_mutation</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>new_xs</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>new_ys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>particle</span><span style=color:#f92672>.</span><span style=color:#111>y</span> <span style=color:#00a8c8>for</span> <span style=color:#111>particle</span> <span style=color:#f92672>in</span> <span style=color:#111>particles</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>new_xs</span><span style=color:#111>,</span> <span style=color:#111>new_ys</span><span style=color:#111>,</span> <span style=color:#111>alpha</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>set_title</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Mutated particles&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>add_artist</span><span style=color:#111>(</span><span style=color:#111>make_arrow</span><span style=color:#111>((</span><span style=color:#ae81ff>0.85</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#ae81ff>0.15</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>],</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]));</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>add_artist</span><span style=color:#111>(</span><span style=color:#111>make_arrow</span><span style=color:#111>((</span><span style=color:#ae81ff>0.85</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#ae81ff>0.15</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>],</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]));</span>
</span></span><span style=display:flex><span><span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>add_artist</span><span style=color:#111>(</span><span style=color:#111>make_arrow</span><span style=color:#111>((</span><span style=color:#ae81ff>0.85</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#ae81ff>0.15</span><span style=color:#111>,</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>),</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>],</span> <span style=color:#111>ax</span><span style=color:#111>[</span><span style=color:#ae81ff>3</span><span style=color:#111>]));</span>
</span></span></code></pre></div><p><img src=output_42_0.png alt=png></p><p>The population progressed much faster towards the target distribution.</p><h2 id=summary>Summary
<a class=anchor href=#summary>#</a></h2><p>To summarize, here is the basic SMC algorithm again:</p><div class=never-hide><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># hyperparameters</span>
</span></span><span style=display:flex><span><span style=color:#111>n_particles</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2000</span>
</span></span><span style=display:flex><span><span style=color:#111>n_steps</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># initialize population of particles from prior</span>
</span></span><span style=display:flex><span><span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>sample_prior</span><span style=color:#111>(</span><span style=color:#111>n_particles</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># main loop</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span> <span style=color:#111>step</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#111>n_steps</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># compute particle weights in proportion</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># to the posterior distribution probability</span>
</span></span><span style=display:flex><span>    <span style=color:#111>weights</span> <span style=color:#f92672>=</span> <span style=color:#111>compute_weights</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>posterior</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># resample particles (with replacement)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># based on their weights</span>
</span></span><span style=display:flex><span>    <span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>resample</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>,</span> <span style=color:#111>weights</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># mutate particles to reintroduce variation</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># and better explore the posterior distribution</span>
</span></span><span style=display:flex><span>    <span style=color:#111>particles</span> <span style=color:#f92672>=</span> <span style=color:#111>mutate</span><span style=color:#111>(</span><span style=color:#111>particles</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># final approximation is given by the final particles</span>
</span></span><span style=display:flex><span><span style=color:#111>posterior</span> <span style=color:#f92672>=</span> <span style=color:#111>particles</span>
</span></span></code></pre></div></div><h2 id=what-about-the-prior>What about the prior?
<a class=anchor href=#what-about-the-prior>#</a></h2><p>You might have noticed a large repetition of the word &ldquo;posterior&rdquo;, and a strange absence of &ldquo;prior&rdquo;. To keep things simple I chose to work with an implicitly uniform prior which does not affect the posterior calculations. Indeed the two are needed for a complete Bayesian inference. And in fact there is something very interesting that can be done when combining the two into a general SMC algorithm. That&rsquo;s the topic of the [next article]!</p><div class=hide style=display:none>nb2hugo raw_notebooks/smc_basic_algorithm.ipynb --site-dir . --section posts</div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/ricardoV94/ricardoV94.github.io.website/edit/master/content/posts/smc_basic_algorithm.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#toy-2d-gaussian-example>Toy 2D Gaussian example</a></li></ul></li><li><a href=#a-particle-is-born>A particle is born</a></li><li><a href=#picking-favorites>Picking favorites</a></li><li><a href=#introducing-variation>Introducing variation</a><ul><li><a href=#blind-evolution>Blind evolution</a></li><li><a href=#intelligent-design>Intelligent design</a></li></ul></li><li><a href=#summary>Summary</a></li><li><a href=#what-about-the-prior>What about the prior?</a></li></ul></nav><script>code_show=!0;function code_toggle(){code_show=!code_show,show=code_show?"block":"none",code_blocks=document.querySelectorAll(":not(.never-hide) > .highlight");for(let e of code_blocks)e.style.display=show}code_toggle()</script><a class=book-btn href=javascript:code_toggle()>Toggle Code</a></div></aside></main></body></html>